<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Enlaces PDF</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div class="container">
        <h1>üßæ Generador de Enlaces con Contador</h1>

        <label for="fechaInicio">üìÖ Fecha de inicio:</label>
        <input type="date" id="fechaInicio">

        <label for="fila">üìÑ N√∫mero de fila en Sheet:</label>
        <input type="number" id="fila" placeholder="Ej: 5">

        <label for="diasVigencia">‚è≥ D√≠as de vigencia:</label>
        <input type="number" id="diasVigencia" value="120"> 

        <button onclick="generarEnlace()">Guardar Fecha y Generar Enlace</button>

        <div id="resultado"></div>
    </div>

    <script>
        // === CRUCIAL: REEMPLAZA ESTA URL CON LA URL DE TU APPS SCRIPT (/exec) === Prueba
        const URL_APPSCRIPT = "https://script.google.com/macros/s/AKfycbzq-oj4mFGwDoLQB2rvE_jy8M3PzsnWP2BHA5wwRahKKzlBBvMoWtbdDcmAXGQyatpR/exec"; 

        /**
         * Funci√≥n callback global: Se ejecuta despu√©s de que Apps Script guarda la fecha.
         * Recibe la respuesta del servidor de Google.
         */
        window.handleGoogleSheetResponse = function(data) {
            
            // 1. Limpieza del elemento JSONP (script)
            const script = document.getElementById('jsonp_script');
            if (script) {
                document.body.removeChild(script);
            }

            // 2. Manejo de errores de la l√≥gica de Apps Script
            if (!data.ok) {
                alert("‚ùå Error al guardar la fecha en Sheet: " + data.error);
                document.getElementById('resultado').innerHTML = `<div class="resultado-error"><p>‚ùå Fall√≥ el guardado: ${data.error}</p></div>`;
                return;
            }

            // 3. √âXITO: Redirecci√≥n al visor p√∫blico
           
            const fila = document.getElementById('fila').value;
            // La URL p√∫blica a compartir apunta a tu Netlify, no al script de Google.
            const enlacePublico = `${window.location.origin}/view.html?fila=${fila}`;
            
            // Muestra el enlace temporalmente
            document.getElementById('resultado').innerHTML = `
                <div class="resultado-box-exito">
                    <p>‚úÖ ¬°Hecho! <br>Redirigiendo a la p√°gina del visor en 3 segundos.</p>
                    <p class="resultado-enlace">Enlace a compartir:</p>
                    <a href="${enlacePublico}" target="_blank"><strong>${enlacePublico}</strong></a>
                    <br>
                    <button onclick="copiar('${enlacePublico}')">üì≤ Copiar enlace</button>
                </div>
            `;
            
            // Redirigir al usuario al visor
            setTimeout(() => {
                window.location.href = enlacePublico;
            }, 3000); 
        }

        /**
         * Funci√≥n principal llamada por el bot√≥n. Inicia el proceso de guardado JSONP.
         */
        function generarEnlace() {
            const fechaInicioInput = document.getElementById('fechaInicio');
            const filaInput = document.getElementById('fila');
            
            const fechaInicio = fechaInicioInput.value;
            const fila = filaInput.value;

            if(!fechaInicio || !fila){
                alert('Por favor completa la Fecha de inicio y el N√∫mero de fila. ‚ö†Ô∏è');
                return;
            }
            
            // ‚ö†Ô∏è La URL debe ser correcta. La funci√≥n handleGoogleSheetResponse ser√° llamada por el servidor.
            const urlGuardado = `${URL_APPSCRIPT}?action=save&fila=${fila}&fechaInicio=${fechaInicio}&callback=handleGoogleSheetResponse`;

            // Creaci√≥n del script (JSONP) para iniciar la llamada
            const script = document.createElement('script');
            script.src = urlGuardado;
            script.id = 'jsonp_script'; 
            document.body.appendChild(script);
        }

        /**
         * Funci√≥n auxiliar para copiar el texto al portapapeles.
         */
        function copiar(texto){
            navigator.clipboard.writeText(texto)
                .then(() => alert('‚úÖ Enlace copiado al portapapeles'))
                .catch(err => {
                    console.error('No se pudo copiar el texto: ', err);
                    alert('‚ùå Error al copiar. Int√©ntalo manualmente.');
                });
        }
    </script>
</body>
</html>
